<!DOCTYPE html>
<html>
   <head>
      <title>Video Streaming Demo</title>
      <style>
         #video-player {
            width: 100%;
         }
      </style>
   </head>
   <body>
      <video
         id="video-player"
         controls></video>

      <script>
         const videoPlayer = document.getElementById('video-player');
         const apiUrl = 'http://localhost:8080/api/v1/stream'; // Thay thế bằng URL API thực tế

         fetch(apiUrl)
            .then((response) => {
               if (!response.ok) {
                  throw new Error('Error calling API');
               }
               return response.body;
            })
            .then((stream) => {
               if (!stream) {
                  throw new Error('Stream not available');
               }

               const mediaSource = new MediaSource();
               videoPlayer.src = URL.createObjectURL(mediaSource);

               mediaSource.addEventListener('sourceopen', () => {
                  const sourceBuffer = mediaSource.addSourceBuffer(
                     'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'
                  );

                  const reader = stream.getReader();
                  let receivedLength = 0;
                  let isAppending = false;

                  function handleData({ done, value }) {
                     if (done) {
                        if (!isAppending) {
                           sourceBuffer.addEventListener('updateend', () => {
                              mediaSource.endOfStream();
                           });
                           sourceBuffer.appendBuffer(new Uint8Array(0));
                        }
                        return;
                     }

                     if (!isAppending) {
                        isAppending = true;
                        receivedLength += value.length;
                        sourceBuffer.appendBuffer(value);
                     } else {
                        reader.read().then(handleData);
                     }
                  }

                  reader.read().then(handleData);
               });
            })
            .catch((error) => {
               console.error('Error streaming video:', error);
            });
      </script>
   </body>
</html>
